{% extends "base.html" %}

{% block title %}–ß–∞—Ç | –°–µ–≤–µ—Ä-–Æ–≥{% endblock %}

{% block extra_css %}
<style>
    /* ===== –°–£–ü–ï–†-–°–û–í–†–ï–ú–ï–ù–ù–´–ô –ß–ê–¢ ===== */
    :root {
        --chat-primary: #4f46e5;
        --chat-secondary: #818cf8;
        --chat-own: #eef2ff;
        --chat-other: #f8fafc;
        --chat-dark: #1e293b;
        --chat-light: #f1f5f9;
        --chat-success: #10b981;
        --chat-warning: #f59e0b;
        --chat-danger: #ef4444;
    }

    .chat-container {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: calc(100vh - 180px);
        background: white;
        border-radius: 30px;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        margin-bottom: 30px;
        position: relative;
    }

    /* ===== –°–ê–ô–î–ë–ê–† ===== */
    .chat-sidebar {
        background: white;
        border-right: 1px solid #f1f5f9;
        display: flex;
        flex-direction: column;
        animation: slideInLeft 0.3s ease;
    }

    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .sidebar-header {
        padding: 24px 20px;
        border-bottom: 1px solid #f1f5f9;
    }

    .sidebar-header h5 {
        margin: 0;
        font-weight: 700;
        color: var(--chat-dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .sidebar-header h5 i {
        color: var(--chat-primary);
        font-size: 1.2rem;
    }

    .ride-info-card {
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        margin: 16px;
        border-radius: 20px;
        padding: 20px;
        color: white;
        position: relative;
        overflow: hidden;
        animation: gradientShift 8s ease infinite;
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .ride-info-card::before {
        content: 'üöó';
        position: absolute;
        right: 10px;
        bottom: 10px;
        font-size: 4rem;
        opacity: 0.1;
        animation: float 4s ease-in-out infinite;
    }

    .ride-route {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ride-time {
        font-size: 0.9rem;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .participants-section {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .participants-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--chat-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
        padding: 0 8px;
    }

    .participant-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 16px;
        margin-bottom: 4px;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
    }

    .participant-item:hover {
        background: var(--chat-light);
        transform: translateX(5px);
    }

    .participant-avatar {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.2rem;
        position: relative;
    }

    .online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 10px;
        height: 10px;
        background: var(--chat-success);
        border-radius: 50%;
        border: 2px solid white;
    }

    .participant-info {
        flex: 1;
    }

    .participant-name {
        font-weight: 600;
        color: var(--chat-dark);
        margin-bottom: 2px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .participant-role {
        font-size: 0.7rem;
        color: var(--chat-secondary);
    }

    .driver-badge {
        background: #f59e0b;
        color: white;
        font-size: 0.6rem;
        padding: 2px 8px;
        border-radius: 30px;
        margin-left: 6px;
    }

    .unread-badge {
        background: var(--chat-primary);
        color: white;
        font-size: 0.7rem;
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 6px;
    }

    /* ===== –û–°–ù–û–í–ù–û–ô –ß–ê–¢ ===== */
    .chat-main {
        display: flex;
        flex-direction: column;
        background: #fafcff;
        animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .chat-header {
        padding: 20px 24px;
        background: white;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .chat-avatar {
        width: 50px;
        height: 50px;
        border-radius: 18px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .chat-details h4 {
        margin: 0 0 4px 0;
        font-weight: 700;
        color: var(--chat-dark);
    }

    .chat-details p {
        margin: 0;
        color: var(--chat-secondary);
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .chat-actions {
        display: flex;
        gap: 8px;
    }

    .chat-action-btn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid #f1f5f9;
        background: white;
        color: var(--chat-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.2rem;
    }

    .chat-action-btn:hover {
        background: var(--chat-primary);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
    }

    /* ===== –°–û–û–ë–©–ï–ù–ò–Ø ===== */
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message-date-divider {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }

    .message-date-divider::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
        background: #e2e8f0;
        z-index: 1;
    }

    .message-date-text {
        background: #fafcff;
        padding: 0 15px;
        color: var(--chat-secondary);
        font-size: 0.8rem;
        position: relative;
        z-index: 2;
    }

    .message-wrapper {
        display: flex;
        gap: 12px;
        animation: messageSlide 0.3s ease;
        max-width: 80%;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-wrapper.own {
        flex-direction: row-reverse;
        margin-left: auto;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
    }

    .message-bubble {
        background: white;
        padding: 12px 18px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        position: relative;
        border: 1px solid #f1f5f9;
    }

    .own .message-bubble {
        background: var(--chat-own);
        border-color: var(--chat-primary);
    }

    .message-sender {
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--chat-primary);
        margin-bottom: 4px;
    }

    .message-text {
        color: var(--chat-dark);
        line-height: 1.5;
        word-wrap: break-word;
        font-size: 0.95rem;
    }

    .message-time {
        font-size: 0.65rem;
        color: var(--chat-secondary);
        margin-top: 4px;
        text-align: right;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
    }

    .message-status {
        font-size: 0.8rem;
    }

    .status-read {
        color: var(--chat-primary);
    }

    .status-sent {
        color: var(--chat-secondary);
    }

    /* ===== –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê ===== */
    .chat-input-area {
        padding: 20px 24px;
        background: white;
        border-top: 1px solid #f1f5f9;
    }

    .input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        background: #fafcff;
        border: 1px solid #f1f5f9;
        border-radius: 30px;
        padding: 8px 8px 8px 20px;
    }

    .message-input {
        flex: 1;
        border: none;
        padding: 10px 0;
        font-size: 0.95rem;
        resize: none;
        max-height: 120px;
        background: transparent;
    }

    .message-input:focus {
        outline: none;
    }

    .input-tools {
        display: flex;
        gap: 4px;
    }

    .input-tool {
        width: 40px;
        height: 40px;
        border-radius: 20px;
        border: none;
        background: transparent;
        color: var(--chat-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.2rem;
    }

    .input-tool:hover {
        background: var(--chat-light);
        color: var(--chat-primary);
        transform: scale(1.1);
    }

    .send-btn {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        font-size: 1.2rem;
    }

    .send-btn:hover {
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
    }

    /* ===== –ë–´–°–¢–†–´–ï –û–¢–í–ï–¢–´ ===== */
    .quick-replies {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .quick-reply {
        padding: 8px 16px;
        background: white;
        border: 1px solid #f1f5f9;
        border-radius: 30px;
        font-size: 0.85rem;
        color: var(--chat-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-reply:hover {
        background: var(--chat-primary);
        color: white;
        border-color: var(--chat-primary);
    }

    /* ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ò–°–¢–û–†–ò–ò ===== */
    .history-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(10px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .history-modal.active {
        display: flex;
    }

    .history-content {
        background: white;
        border-radius: 40px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 40px 80px rgba(0,0,0,0.2);
        animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    .history-header {
        padding: 30px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-header h3 {
        margin: 0;
        font-weight: 700;
    }

    .history-close {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.2rem;
    }

    .history-close:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .history-list {
        padding: 24px;
        overflow-y: auto;
        max-height: calc(80vh - 120px);
    }

    .history-item {
        display: flex;
        gap: 16px;
        padding: 16px;
        border-radius: 20px;
        margin-bottom: 12px;
        background: #f8fafc;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .history-item:hover {
        border-color: var(--chat-primary);
        transform: translateX(5px);
        background: white;
        box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1);
    }

    .history-icon {
        width: 50px;
        height: 50px;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-secondary) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .history-info {
        flex: 1;
    }

    .history-title {
        font-weight: 600;
        color: var(--chat-dark);
        margin-bottom: 4px;
    }

    .history-subtitle {
        color: var(--chat-secondary);
        font-size: 0.9rem;
    }

    .history-date {
        font-size: 0.8rem;
        color: #adb5bd;
        margin-top: 4px;
    }

    /* ===== –≠–ú–û–î–ó–ò –ü–ò–ö–ï–† ===== */
    .emoji-picker {
        position: absolute;
        bottom: 80px;
        right: 30px;
        background: white;
        border-radius: 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        max-width: 400px;
        border: 1px solid #f1f5f9;
        display: none;
        z-index: 100;
    }

    .emoji-picker.active {
        display: grid;
        animation: scaleIn 0.2s ease;
    }

    .emoji-item {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        border-radius: 12px;
        transition: all 0.2s;
    }

    .emoji-item:hover {
        background: var(--chat-light);
        transform: scale(1.2);
    }

    /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
    @media (max-width: 768px) {
        .chat-container {
            grid-template-columns: 1fr;
            height: calc(100vh - 140px);
        }

        .chat-sidebar {
            display: none;
        }

        .chat-sidebar.active {
            display: flex;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            background: white;
        }

        .message-wrapper {
            max-width: 90%;
        }

        .chat-actions {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <h5>
                <i class="bi bi-chat"></i>
                {% if ride %}
                –î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏
                {% else %}
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                {% endif %}
            </h5>
        </div>

        {% if ride %}
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–µ–∑–¥–∫–µ -->
        <div class="ride-info-card">
            <div class="ride-route">
                <i class="bi bi-geo-alt"></i> {{ ride.from_place }}
            </div>
            <div class="ride-route" style="margin-left: 20px;">
                <i class="bi bi-arrow-down"></i> {{ ride.to_place }}
            </div>
            <div class="ride-time">
                <i class="bi bi-clock"></i> {{ ride.departure_time.strftime('%d.%m.%Y %H:%M') }}
            </div>
        </div>
        {% endif %}

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="participants-section">
            <div class="participants-title">
                <i class="bi bi-people"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ participants|length }})
            </div>

            {% for participant in participants %}
            <div class="participant-item" onclick="window.location.href='/profile/{{ participant.user.id }}'">
                <div class="participant-avatar">
                    {{ participant.user.name[0] }}
                    <span class="online-indicator" style="display: {{ 'block' if participant.user.is_online else 'none' }};"></span>
                </div>
                <div class="participant-info">
                    <div class="participant-name">
                        {{ participant.user.name }}
                        {% if participant.user.id == ride.driver_id %}
                        <span class="driver-badge">üöó</span>
                        {% endif %}
                    </div>
                    <div class="participant-role">
                        {% if participant.user.id == ride.driver_id %}
                        –í–æ–¥–∏—Ç–µ–ª—å
                        {% else %}
                        –ü–∞—Å—Å–∞–∂–∏—Ä
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-info">
                <div class="chat-avatar">
                    {{ other_user.name[0] if other_user else '?' }}
                </div>
                <div class="chat-details">
                    <h4>{{ other_user.name if other_user else '–ß–∞—Ç' }}</h4>
                    <p>
                        <i class="bi bi-circle-fill" style="color: #10b981; font-size: 0.6rem;"></i>
                        {% if other_user %}
                        {{ '–í —Å–µ—Ç–∏' if other_user.is_online else '–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ' }}
                        {% else %}
                        –ù–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="chat-actions">
                <button class="chat-action-btn" onclick="showRideHistory()" title="–ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button class="chat-action-btn" onclick="window.location.href='/profile/{{ other_user.id }}'" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <i class="bi bi-person"></i>
                </button>
                <button class="chat-action-btn" onclick="toggleFullscreen()" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="messages-container" id="messagesContainer">
            {% set current_date = None %}
            {% for msg in messages %}
            {% set msg_date = msg.created_at.strftime('%d.%m.%Y') %}
            {% if msg_date != current_date %}
            {% set current_date = msg_date %}
            <div class="message-date-divider">
                <span class="message-date-text">{{ msg_date }}</span>
            </div>
            {% endif %}

            <div class="message-wrapper {% if msg.sender_id == user.id %}own{% endif %}" id="message-{{ msg.id }}">
                <div class="message-avatar">
                    {{ msg.sender.name[0] if msg.sender else '?' }}
                </div>
                <div class="message-content">
                    {% if msg.sender_id != user.id %}
                    <div class="message-sender">{{ msg.sender.name if msg.sender else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</div>
                    {% endif %}
                    <div class="message-bubble">
                        <div class="message-text">{{ msg.text }}</div>
                        <div class="message-time">
                            {{ msg.created_at.strftime('%H:%M') }}
                            {% if msg.sender_id == user.id %}
                            {% if msg.is_read %}
                            <i class="bi bi-check2-all status-read"></i>
                            {% else %}
                            <i class="bi bi-check2 status-sent"></i>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea class="message-input" id="messageInput"
                          placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
                          onkeydown="handleKeyDown(event)"></textarea>

                <div class="input-tools">
                    <button class="input-tool" onclick="toggleEmojiPicker()">
                        <i class="bi bi-emoji-smile"></i>
                    </button>
                </div>

                <button class="send-btn" onclick="sendMessage()">
                    <i class="bi bi-send"></i>
                </button>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã -->
            <div class="quick-replies">
                <span class="quick-reply" onclick="insertQuickReply('‚úÖ –î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å')">‚úÖ –î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å</span>
                <span class="quick-reply" onclick="insertQuickReply('üïê –í–æ —Å–∫–æ–ª—å–∫–æ?')">üïê –í–æ —Å–∫–æ–ª—å–∫–æ?</span>
                <span class="quick-reply" onclick="insertQuickReply('üìç –ì–¥–µ –≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è?')">üìç –ì–¥–µ?</span>
                <span class="quick-reply" onclick="insertQuickReply('üí∞ –°–∫–æ–ª—å–∫–æ?')">üí∞ –°–∫–æ–ª—å–∫–æ?</span>
            </div>
        </div>
    </div>
</div>

<!-- –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä -->
<div class="emoji-picker" id="emojiPicker">
    <span class="emoji-item" onclick="addEmoji('üòä')">üòä</span>
    <span class="emoji-item" onclick="addEmoji('üëç')">üëç</span>
    <span class="emoji-item" onclick="addEmoji('üöó')">üöó</span>
    <span class="emoji-item" onclick="addEmoji('üëã')">üëã</span>
    <span class="emoji-item" onclick="addEmoji('‚úÖ')">‚úÖ</span>
    <span class="emoji-item" onclick="addEmoji('‚ùå')">‚ùå</span>
    <span class="emoji-item" onclick="addEmoji('üìç')">üìç</span>
    <span class="emoji-item" onclick="addEmoji('üí∞')">üí∞</span>
    <span class="emoji-item" onclick="addEmoji('üïê')">üïê</span>
    <span class="emoji-item" onclick="addEmoji('üéâ')">üéâ</span>
    <span class="emoji-item" onclick="addEmoji('üôè')">üôè</span>
    <span class="emoji-item" onclick="addEmoji('üíØ')">üíØ</span>
    <span class="emoji-item" onclick="addEmoji('‚ö°')">‚ö°</span>
    <span class="emoji-item" onclick="addEmoji('‚≠ê')">‚≠ê</span>
    <span class="emoji-item" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span class="emoji-item" onclick="addEmoji('üî•')">üî•</span>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
<div class="history-modal" id="historyModal">
    <div class="history-content">
        <div class="history-header">
            <h3><i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫</h3>
            <button class="history-close" onclick="closeHistoryModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="history-list" id="historyList">
            <!-- –°—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è -->
        </div>
    </div>
</div>

<script>
    let lastMessageId = {% if messages %}{{ messages[-1].id }}{% else %}0{% endif %};
    const rideId = {% if ride %}{{ ride.id }}{% else %}null{% endif %};
    const receiverId = {{ receiver_id }};
    const currentUserId = {{ user.id }};
    let fullscreen = false;

    // –ê–≤—Ç–æ-–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
    function handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text) return;

        fetch('/api/send_message', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ride_id: rideId,
                receiver_id: receiverId,
                text: text
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addMessage(data.message);
                input.value = '';
                input.style.height = 'auto';
            }
        });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function addMessage(msg) {
        const container = document.getElementById('messagesContainer');
        const date = new Date().toLocaleDateString('ru-RU');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã
        const lastDivider = container.querySelector('.message-date-divider:last-child');
        if (!lastDivider || !lastDivider.textContent.includes(date)) {
            const divider = document.createElement('div');
            divider.className = 'message-date-divider';
            divider.innerHTML = `<span class="message-date-text">${date}</span>`;
            container.appendChild(divider);
        }

        const div = document.createElement('div');
        div.className = `message-wrapper ${msg.sender_id == currentUserId ? 'own' : ''}`;
        div.id = `message-${msg.id}`;
        div.innerHTML = `
            <div class="message-avatar">${msg.sender_name ? msg.sender_name[0] : '?'}</div>
            <div class="message-content">
                ${msg.sender_id != currentUserId ?
                    `<div class="message-sender">${msg.sender_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>` : ''}
                <div class="message-bubble">
                    <div class="message-text">${msg.text}</div>
                    <div class="message-time">
                        ${msg.created_at}
                        ${msg.sender_id == currentUserId ?
                            '<i class="bi bi-check2 status-sent"></i>' : ''}
                    </div>
                </div>
            </div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        if (msg.id > lastMessageId) {
            lastMessageId = msg.id;
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    function checkNewMessages() {
        if (!rideId) return;

        fetch(`/api/get_messages/${rideId}?since=${lastMessageId}`)
            .then(response => response.json())
            .then(messages => {
                messages.forEach(msg => addMessage(msg));
            });
    }

    // –≠–º–æ–¥–∑–∏
    function toggleEmojiPicker() {
        document.getElementById('emojiPicker').classList.toggle('active');
    }

    function addEmoji(emoji) {
        const input = document.getElementById('messageInput');
        input.value += emoji;
        input.focus();
        document.getElementById('emojiPicker').classList.remove('active');
    }

    // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
    function insertQuickReply(text) {
        const input = document.getElementById('messageInput');
        input.value = text;
        input.focus();
    }

    // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫
    function showRideHistory() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('historyList');

        fetch(`/api/ride_history?user_id=${receiverId}`)
            .then(response => response.json())
            .then(data => {
                let html = '';

                if (data.as_driver.length === 0 && data.as_passenger.length === 0) {
                    html = '<p class="text-muted py-4 text-center">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–µ–∑–¥–æ–∫</p>';
                } else {
                    data.as_driver.forEach(ride => {
                        html += `
                            <div class="history-item" onclick="window.location.href='/ride/${ride.id}'">
                                <div class="history-icon">üöó</div>
                                <div class="history-info">
                                    <div class="history-title">${ride.from} ‚Üí ${ride.to}</div>
                                    <div class="history-subtitle">${ride.time}</div>
                                    <div class="history-date">–í–æ–¥–∏—Ç–µ–ª—å</div>
                                </div>
                            </div>
                        `;
                    });

                    data.as_passenger.forEach(ride => {
                        html += `
                            <div class="history-item" onclick="window.location.href='/ride/${ride.id}'">
                                <div class="history-icon">üë§</div>
                                <div class="history-info">
                                    <div class="history-title">${ride.from} ‚Üí ${ride.to}</div>
                                    <div class="history-subtitle">${ride.time}</div>
                                    <div class="history-date">–ü–∞—Å—Å–∞–∂–∏—Ä</div>
                                </div>
                            </div>
                        `;
                    });
                }

                list.innerHTML = html;
            });

        modal.classList.add('active');
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').classList.remove('active');
    }

    // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
    function toggleFullscreen() {
        const container = document.querySelector('.chat-container');
        if (!fullscreen) {
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.right = '0';
            container.style.bottom = '0';
            container.style.zIndex = '9999';
            container.style.height = '100vh';
            container.style.borderRadius = '0';
            fullscreen = true;
        } else {
            container.style.position = 'static';
            container.style.height = 'calc(100vh - 180px)';
            container.style.borderRadius = '30px';
            container.style.zIndex = 'auto';
            fullscreen = false;
        }
    }

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    setInterval(checkNewMessages, 3000);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —ç–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', function(event) {
        const picker = document.getElementById('emojiPicker');
        const btn = document.querySelector('.input-tool[onclick="toggleEmojiPicker()"]');

        if (picker && btn && !picker.contains(event.target) && !btn.contains(event.target)) {
            picker.classList.remove('active');
        }
    });
</script>
{% endblock %}