{% extends "base.html" %}

{% block title %}–ü–æ–∏—Å–∫ –ø–æ–ø—É—Ç–æ–∫ | –°–µ–≤–µ—Ä-–Æ–≥{% endblock %}

{% block extra_css %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=4932c58f-dc3f-4c34-b0ca-a64c1ef43dca&lang=ru_RU" type="text/javascript"></script>
<style>
    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω */
    .search-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 20px;
        border-radius: 20px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .search-card {
        background: white;
        border-radius: 25px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .address-group {
        background: #f8f9fa;
        border-radius: 20px;
        padding: 5px;
        margin-bottom: 20px;
    }

    .address-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border-radius: 15px;
        transition: all 0.3s;
    }

    .address-item:first-child {
        margin-bottom: 5px;
    }

    .address-item:hover {
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .address-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1.2rem;
    }

    .from-icon {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .to-icon {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    .address-input {
        background: transparent;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 8px 12px;
        transition: all 0.3s;
        width: 100%;
        font-size: 1rem;
    }

    .address-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .address-input::placeholder {
        color: #adb5bd;
    }

    .swap-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e9ecef;
        color: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 10;
    }

    .swap-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-50%) rotate(180deg);
    }

    .favorite-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        padding: 20px;
        margin: 20px 0;
    }

    .section-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .favorite-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
    }

    .favorite-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 16px;
        padding: 15px 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .favorite-card:hover {
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
    }

    .favorite-emoji {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .favorite-name {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: #495057;
    }

    .favorite-address {
        font-size: 0.7rem;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .popular-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 16px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .popular-card:hover {
        border-color: #ffc107;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(255, 193, 7, 0.2);
    }

    .popular-route {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .popular-icon {
        color: #ffc107;
    }

    .popular-desc {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .map-container {
        border-radius: 25px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        margin-bottom: 30px;
        height: 500px;
        border: 3px solid white;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .search-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 20px;
        padding: 18px;
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
        width: 100%;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        margin-top: 20px;
    }

    .search-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .search-btn i {
        margin-right: 8px;
    }

    .ride-card {
        background: white;
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid #e9ecef;
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .ride-card:hover {
        border-color: #667eea;
        transform: translateX(5px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
    }

    .ride-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        opacity: 0;
        transition: opacity 0.3s;
    }

    .ride-card:hover::before {
        opacity: 1;
    }

    .driver-badge {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .driver-avatar {
        width: 50px;
        height: 50px;
        border-radius: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .price-tag {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 6px 15px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1.1rem;
        display: inline-block;
    }

    .free-tag {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
        padding: 6px 15px;
        border-radius: 50px;
        font-weight: 700;
    }

    .stats-panel {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        padding: 20px;
        margin-top: 20px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .tip-box {
        background: #e3f2fd;
        border-radius: 16px;
        padding: 15px;
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 4px solid #2196f3;
    }

    .tip-icon {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2196f3;
        font-size: 1.2rem;
    }

    .tip-text {
        color: #0d47a1;
        font-size: 0.95rem;
    }

    .empty-state {
        text-align: center;
        padding: 50px 20px;
        background: #f8f9fa;
        border-radius: 20px;
    }

    .empty-icon {
        font-size: 4rem;
        color: #adb5bd;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è -->
<div class="search-hero">
    <h1 class="display-5 mb-3"><i class="bi bi-search"></i> –ü–æ–∏—Å–∫ –ø–æ–ø—É—Ç–æ–∫</h1>
    <p class="mb-0">–ù–∞–π–¥–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –µ–¥–µ—Ç –ø–æ –≤–∞—à–µ–º—É –º–∞—Ä—à—Ä—É—Ç—É</p>
</div>
<!-- –í–∫–ª–∞–¥–∫–∏ –ø–æ–∏—Å–∫–∞ -->
<ul class="nav nav-pills mb-4" id="searchTabs" role="tablist" align="center">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="search-tab" data-bs-toggle="pill" data-bs-target="#search" type="button" role="tab">
            <i class="bi bi-search"></i> –ü–æ–∏—Å–∫ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="map-tab" data-bs-toggle="pill" data-bs-target="#mapView" type="button" role="tab">
            <i class="bi bi-map"></i> –í—Å–µ –≤–æ–¥–∏—Ç–µ–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
        </button>
    </li>
</ul>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
<div class="tab-content">
    <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É -->
    <div class="tab-pane fade show active" id="search" role="tabpanel">
<div class="row">
    <div class="col-lg-5">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="search-card">
            <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–æ–≤ -->
            <div class="address-group">
                <div class="address-item">
                    <div class="address-icon from-icon">
                        <i class="bi bi-geo-alt-fill"></i>
                    </div>
                    <input type="text" class="address-input" id="fromInput"
                           placeholder="–û—Ç–∫—É–¥–∞? (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞)" autocomplete="off">
                </div>

                <div class="address-item">
                    <div class="address-icon to-icon">
                        <i class="bi bi-flag-fill"></i>
                    </div>
                    <input type="text" class="address-input" id="toInput"
                           placeholder="–ö—É–¥–∞? (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)" autocomplete="off">
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏ -->
                <div class="swap-btn" onclick="swapAddresses()" title="–ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏">
                    <i class="bi bi-arrow-down-up"></i>
                </div>
            </div>

            <input type="hidden" id="from_lat">
            <input type="hidden" id="from_lng">
            <input type="hidden" id="to_lat">
            <input type="hidden" id="to_lng">

            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
            <div class="tip-box">
                <div class="tip-icon">
                    <i class="bi bi-lightbulb"></i>
                </div>
                <div class="tip-text">
                    <strong>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É, –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å
                </div>
            </div>

            <!-- –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
            <div class="favorite-section" align="center">
                <div class="section-title">
                    <i class="bi bi-star-fill text-warning"></i>
                    <span>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞</span>
                </div>
                <div class="favorite-grid" id="favoritesList">
                    <div class="text-center py-4" id="favoritesLoading">
                        <div class="spinner-border text-primary" style="width: 2rem; height: 2rem;"></div>
                        <p class="mt-2 small">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>
            </div>

            <script>
                function loadFavorites() {
                    const container = document.getElementById('favoritesList');
                    const loading = document.getElementById('favoritesLoading');

                    fetch('/api/favorite_routes')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(routes => {
                            if (!routes || routes.length === 0) {
                                container.innerHTML = `
                                    <div align="center" class="text-center text-muted py-4" style="grid-column: 1/-1;">
                                        <i class="bi bi-star" style="font-size: 2rem;"></i>
                                        <p class="mb-0 mt-2">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç</p>
                                        <small>–î–æ–±–∞–≤—å—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</small>
                                    </div>
                                `;
                                return;
                            }

                            let html = '';
                            routes.forEach(route => {
                                html += `
                                    <div class="favorite-card" onclick="useFavorite(${route.id})">
                                        <div class="favorite-emoji">üìç</div>
                                        <div class="favorite-name">${route.name || '–ú–∞—Ä—à—Ä—É—Ç'}</div>
                                        <div class="favorite-address">${route.from_place.split(',')[0]}</div>
                                        <div class="favorite-address text-muted mt-1">
                                            <small>‚Üí ${route.to_place.split(',')[0]}</small>
                                        </div>
                                    </div>
                                `;
                            });
                            container.innerHTML = html;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            container.innerHTML = `
                                <div class="text-center text-muted py-4" style="grid-column: 1/-1;">
                                    <i class="bi bi-exclamation-circle text-danger" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                                    <small class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ</small>
                                </div>
                            `;
                        });
                }

                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
                document.addEventListener('DOMContentLoaded', loadFavorites);
            </script>

            <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) -->
            <div class="favorite-section">
                <div class="section-title">
                    <i class="bi bi-fire text-danger"></i>
                    <span>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="popular-card" onclick="setRoute('–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞', '–ø–ª. –ù–∞—Ö–∏–º–æ–≤–∞')" style="width: 100%;">
                        <div class="popular-route">
                            <span>–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞</span>
                            <i class="bi bi-arrow-right popular-icon"></i>
                            <span>–ø–ª. –ù–∞—Ö–∏–º–æ–≤–∞</span>
                        </div>
                        <div align="center" " class="popular-desc">üèõÔ∏è –¶–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞</div>
                    </div>

                    <div class="popular-card" onclick="setRoute('–ø–ª. –ù–∞—Ö–∏–º–æ–≤–∞', '–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞')" style="width: 100%;">
                        <div class="popular-route">
                            <span>–ø–ª. –ù–∞—Ö–∏–º–æ–≤–∞</span>
                            <i class="bi bi-arrow-right popular-icon"></i>
                            <span>–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞</span>
                        </div>
                        <div align="center" class="popular-desc">üèõÔ∏è –°–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞</div>
                    </div>

                    <div class="popular-card" onclick="setRoute('–ø–ª. –£—à–∞–∫–æ–≤–∞', '–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞')" style="width: 100%;">
                        <div class="popular-route">
                            <span>–ø–ª. –£—à–∞–∫–æ–≤–∞</span>
                            <i class="bi bi-arrow-right popular-icon"></i>
                            <span>–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞</span>
                        </div>
                        <div align="center" class="popular-desc">üèõÔ∏è –°–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞</div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
            <button class="search-btn" onclick="searchRides()">
                <i class="bi bi-search"></i> –ù–∞–π—Ç–∏ –ø–æ–ø—É—Ç–∫–∏
            </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="row">
                <div class="col-4 stat-item">
                    <div class="stat-value" id="statsCount">0</div>
                    <div class="stat-label">–ø–æ–µ–∑–¥–æ–∫</div>
                </div>
                <div class="col-4 stat-item">
                    <div class="stat-value" id="statsAvgPrice">0</div>
                    <div class="stat-label">—Å—Ä–µ–¥–Ω—è—è</div>
                </div>
                <div class="col-4 stat-item">
                    <div class="stat-value" id="statsFree">0</div>
                    <div class="stat-label">–±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
<div id="results" style="display: none;">
    <h3 class="mb-4">
        <i class="bi bi-list-check"></i>
        –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ <span id="resultsCount" class="badge bg-primary">0</span>
    </h3>
    <div id="ridesList" class="row"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success"></i>
                    –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button type="button" class="btn btn-success" onclick="bookRide()" id="bookBtn">
                    <i class="bi bi-check"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –∫–∞—Ä—Ç—ã —Å–æ –≤—Å–µ–º–∏ –≤–æ–¥–∏—Ç–µ–ª—è–º–∏ -->
    <div class="tab-pane fade" id="mapView" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-geo-alt-fill text-primary"></i>
                    –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏
                </h5>
                <p class="text-muted small">–ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–º–µ—á–µ–Ω—ã –≤–æ–¥–∏—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ–¥—É—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>

                <!-- –ö–∞—Ä—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π -->
                <div id="globalMap" style="width: 100%; height: 400px; border-radius: 15px;"></div>

                <!-- –°–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π -->
                <div id="globalDriversList" class="mt-4"></div>
            </div>
        </div>
    </div>
</div>
<script>
    let globalMap;
    let globalMarkers = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã
    function initGlobalMap() {
        if (!ymaps) return;

        globalMap = new ymaps.Map("globalMap", {
            center: [44.6165, 33.5256],
            zoom: 12,
            controls: ['zoomControl', 'fullscreenControl', 'geolocationControl']
        });

        loadAllDrivers();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
    function loadAllDrivers() {
        fetch('/api/active_drivers')
            .then(response => response.json())
            .then(drivers => {
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                if (globalMarkers.length > 0) {
                    globalMarkers.forEach(marker => globalMap.geoObjects.remove(marker));
                    globalMarkers = [];
                }

                if (drivers.length === 0) {
                    document.getElementById('globalDriversList').innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> –°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π
                        </div>
                    `;
                    return;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç—É
                drivers.forEach(driver => {
                    const marker = new ymaps.Placemark(
                        [driver.from_lat, driver.from_lng],
                        {
                            balloonContent: `
                                <div style="min-width: 200px;">
                                    <strong>${driver.driver_name}</strong><br>
                                    <span class="small">${driver.from_place} ‚Üí ${driver.to_place}</span><br>
                                    <span class="small">üïê ${driver.time}</span><br>
                                    <span class="small">üë• ${driver.seats} –º–µ—Å—Ç</span><br>
                                    ${driver.price === 0 ?
                                        '<span class="badge bg-success mt-2">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>' :
                                        `<span class="badge bg-warning mt-2">${driver.price} ‚ÇΩ</span>`}
                                    <br>
                                    <a href="/ride/${driver.id}" class="btn btn-primary btn-sm mt-2 w-100">
                                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                    </a>
                                </div>
                            `,
                            iconContent: 'üöó'
                        },
                        {
                            preset: 'islands#blueStretchyIcon',
                            draggable: false
                        }
                    );

                    globalMap.geoObjects.add(marker);
                    globalMarkers.push(marker);
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π
                displayDriversList(drivers);
            });
    }

    function displayDriversList(drivers) {
        const container = document.getElementById('globalDriversList');

        let html = '<div class="row g-3">';
        drivers.forEach(driver => {
            html += `
                <div class="col-md-6">
                    <div class="card driver-card" onclick="window.location.href='/ride/${driver.id}'" style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1">${driver.driver_name}</h6>
                                    <p class="mb-1 small text-muted">
                                        <i class="bi bi-geo-alt"></i> ${driver.from_place}
                                    </p>
                                    <p class="mb-1 small text-muted">
                                        <i class="bi bi-flag"></i> ${driver.to_place}
                                    </p>
                                    <p class="mb-1 small">
                                        <i class="bi bi-clock"></i> ${driver.time}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-info mb-2">${driver.seats} –º–µ—Å—Ç</span>
                                    ${driver.price === 0 ?
                                        '<span class="badge bg-success d-block">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>' :
                                        `<span class="badge bg-warning d-block">${driver.price} ‚ÇΩ</span>`}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    const style = document.createElement('style');
    style.textContent = `
        .driver-card {
            transition: all 0.3s;
            border: 1px solid #e9ecef;
            border-radius: 15px;
        }
        .driver-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }
        .nav-pills .nav-link {
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: 600;
        }
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    `;
    document.head.appendChild(style);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        if (document.getElementById('mapView').classList.contains('show')) {
            loadAllDrivers();
        }
    }, 30000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    ymaps.ready(() => {
        if (document.getElementById('globalMap')) {
            initGlobalMap();
        }
    });
</script>
<script>
    let map;
    let fromPlacemark = null;
    let toPlacemark = null;
    let route = null;
    let currentRideId = null;
    let currentRide = null;
    let allRides = [];
    let searchControl = null;

    ymaps.ready(init);

    function init() {
        map = new ymaps.Map("map", {
            center: [44.6165, 33.5256],
            zoom: 13,
            controls: ['zoomControl', 'fullscreenControl', 'geolocationControl', 'typeSelector']
        });

        // –ü–æ–∏—Å–∫ –Ω–∞ –∫–∞—Ä—Ç–µ
        searchControl = new ymaps.control.SearchControl({
            options: {
                float: 'right',
                noPlacemark: true,
                provider: 'yandex#search'
            }
        });
        map.controls.add(searchControl);

        searchControl.events.add('resultselect', function(e) {
            const index = e.get('index');
            searchControl.getResult(index).then(function(res) {
                const coords = res.geometry.getCoordinates();
                const address = res.properties.get('name');

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–µ –ø–æ–ª–µ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ (–ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∫–ª–∏–∫—É)
                if (!document.getElementById('from_lat').value) {
                    setFromPoint(coords, address);
                } else if (!document.getElementById('to_lat').value) {
                    setToPoint(coords, address);
                } else {
                    // –ï—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ –µ—Å—Ç—å, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
                    if (confirm('–ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è?')) {
                        setFromPoint(coords, address);
                    } else {
                        setToPoint(coords, address);
                    }
                }
            });
        });

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
        map.events.add('click', function(e) {
            const coords = e.get('coords');
            ymaps.geocode(coords).then(function(res) {
                const address = res.geoObjects.get(0).getAddressLine();

                if (!document.getElementById('from_lat').value) {
                    setFromPoint(coords, address);
                } else if (!document.getElementById('to_lat').value) {
                    setToPoint(coords, address);
                } else {
                    if (confirm('–ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è?')) {
                        setFromPoint(coords, address);
                    } else {
                        setToPoint(coords, address);
                    }
                }
            });
        });

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        map.controls.get('geolocationControl').events.add('locationchange', function(e) {
            const position = e.get('position');
            const coords = [position.latitude, position.longitude];

            ymaps.geocode(coords).then(function(res) {
                const address = res.geoObjects.get(0).getAddressLine();

                if (!document.getElementById('from_lat').value) {
                    setFromPoint(coords, address);
                } else {
                    setFromPoint(coords, address);
                }
            });
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞
        loadFavorites();
    }

    function swapAddresses() {
        const fromLat = document.getElementById('from_lat').value;
        const fromLng = document.getElementById('from_lng').value;
        const toLat = document.getElementById('to_lat').value;
        const toLng = document.getElementById('to_lng').value;
        const fromAddr = document.getElementById('fromInput').value;
        const toAddr = document.getElementById('toInput').value;

        if (fromAddr && toAddr) {
            setFromPoint([toLat, toLng], toAddr);
            setToPoint([fromLat, fromLng], fromAddr);
        }
    }

    function loadFavorites() {
        fetch('/api/favorite_routes')
            .then(response => response.json())
            .then(routes => {
                const container = document.getElementById('favoritesList');

                if (!routes || routes.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-star" style="font-size: 2rem;"></i>
                            <p class="mb-0 mt-2">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç</p>
                            <small>–î–æ–±–∞–≤—å—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</small>
                        </div>
                    `;
                    return;
                }

                let html = '';
                routes.forEach(route => {
                    html += `
                        <div class="favorite-card" onclick="useFavorite(${route.id})">
                            <div class="favorite-emoji">üìç</div>
                            <div class="favorite-name">${route.name || '–ú–∞—Ä—à—Ä—É—Ç'}</div>
                            <div class="favorite-address">${route.from_place}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(() => {
                document.getElementById('favoritesList').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-circle"></i>
                        <p class="mb-0 mt-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                    </div>
                `;
            });
    }

    function useFavorite(favId) {
        window.location.href = `/api/search_favorite/${favId}`;
    }

    function setFromPoint(coords, address) {
        document.getElementById('fromInput').value = address;
        document.getElementById('from_lat').value = coords[0];
        document.getElementById('from_lng').value = coords[1];

        if (fromPlacemark) map.geoObjects.remove(fromPlacemark);

        fromPlacemark = new ymaps.Placemark(coords, {
            balloonContent: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ' + address,
            iconContent: '–ê'
        }, {
            preset: 'islands#greenStretchyIcon',
            draggable: true
        });

        fromPlacemark.events.add('dragend', function(e) {
            const newCoords = e.get('target').geometry.getCoordinates();
            ymaps.geocode(newCoords).then(res => {
                setFromPoint(newCoords, res.geoObjects.get(0).getAddressLine());
            });
        });

        map.geoObjects.add(fromPlacemark);
        map.setCenter(coords, 15);
        buildRoute();
    }

    function setToPoint(coords, address) {
        document.getElementById('toInput').value = address;
        document.getElementById('to_lat').value = coords[0];
        document.getElementById('to_lng').value = coords[1];

        if (toPlacemark) map.geoObjects.remove(toPlacemark);

        toPlacemark = new ymaps.Placemark(coords, {
            balloonContent: '–ü—Ä–∏–±—ã—Ç–∏–µ: ' + address,
            iconContent: '–ë'
        }, {
            preset: 'islands#redStretchyIcon',
            draggable: true
        });

        toPlacemark.events.add('dragend', function(e) {
            const newCoords = e.get('target').geometry.getCoordinates();
            ymaps.geocode(newCoords).then(res => {
                setToPoint(newCoords, res.geoObjects.get(0).getAddressLine());
            });
        });

        map.geoObjects.add(toPlacemark);
        map.setCenter(coords, 15);
        buildRoute();
    }

    function buildRoute() {
        if (route) map.geoObjects.remove(route);

        const fromLat = document.getElementById('from_lat').value;
        const fromLng = document.getElementById('from_lng').value;
        const toLat = document.getElementById('to_lat').value;
        const toLng = document.getElementById('to_lng').value;

        if (fromLat && toLat) {
            ymaps.route([[fromLat, fromLng], [toLat, toLng]], {
                avoidTrafficJams: true,
                routingMode: 'auto'
            }).then(function(routeRes) {
                route = routeRes;
                map.geoObjects.add(route);
            });
        }
    }

    function setRoute(from, to) {
        const routes = {
            '–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞': ['–ø–ª. –ó–∞—Ö–∞—Ä–æ–≤–∞', 44.62588, 33.53742],
            '–ø–ª. –ù–∞—Ö–∏–º–æ–≤–∞': ['–ø–ª. –ù–∞—Ö–∏–º–æ–≤–∞', 44.615806, 33.525365],
            '–ø–ª. –£—à–∞–∫–æ–≤–∞': ['–ø–ª. –£—à–∞–∫–æ–≤–∞', 44.600544, 33.524351]
        };

        if (from in routes && to in routes) {
            setFromPoint([routes[from][1], routes[from][2]], routes[from][0]);
            setTimeout(() => {
                setToPoint([routes[to][1], routes[to][2]], routes[to][0]);
            }, 500);
        }
    }

    function searchRides() {
        const fromLat = document.getElementById('from_lat').value;
        const fromLng = document.getElementById('from_lng').value;
        const toLat = document.getElementById('to_lat').value;
        const toLng = document.getElementById('to_lng').value;

        if (!fromLat || !toLat) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–∏–±—ã—Ç–∏—è');
            return;
        }

        document.getElementById('ridesList').innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <p class="mt-3">–ü–æ–∏—Å–∫ –ø–æ–µ–∑–¥–æ–∫...</p>
                </div>
            </div>
        `;
        document.getElementById('results').style.display = 'block';

        fetch(`/api/search_rides?from_lat=${fromLat}&from_lng=${fromLng}&to_lat=${toLat}&to_lng=${toLng}`)
            .then(response => response.json())
            .then(rides => {
                allRides = rides;
                displayRides(rides);
            })
            .catch(() => {
                document.getElementById('ridesList').innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <div class="empty-icon">‚ùå</div>
                            <h5>–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</h5>
                            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑</p>
                        </div>
                    </div>
                `;
            });
    }

    function displayRides(rides) {
        const container = document.getElementById('ridesList');
        const count = document.getElementById('resultsCount');
        const statsPanel = document.getElementById('statsPanel');

        count.textContent = rides.length;

        if (rides.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h5>–ü–æ–µ–∑–¥–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h5>
                        <p class="text-muted mb-4">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏–ª–∏ –≤—Ä–µ–º—è</p>
                        <a href="/create_ride" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É
                        </a>
                    </div>
                </div>
            `;
            statsPanel.style.display = 'none';
            return;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const avgPrice = Math.round(rides.reduce((sum, r) => sum + r.price, 0) / rides.length);
        const freeCount = rides.filter(r => r.price === 0).length;

        document.getElementById('statsCount').textContent = rides.length;
        document.getElementById('statsAvgPrice').textContent = avgPrice + '‚ÇΩ';
        document.getElementById('statsFree').textContent = freeCount;
        statsPanel.style.display = 'block';

        let html = '';
        rides.forEach(ride => {
            const priceTag = ride.price === 0
                ? '<span class="free-tag"><i class="bi bi-gift"></i> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>'
                : `<span class="price-tag">${ride.price} ‚ÇΩ</span>`;

            const firstLetter = ride.driver_name ? ride.driver_name[0] : '?';

            html += `
                <div class="col-md-6">
                    <div class="ride-card" onclick="showRideDetails(${JSON.stringify(ride).replace(/"/g, '&quot;')})">
                        <div class="driver-badge">
                            <div class="driver-avatar">
                                ${firstLetter}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${ride.driver_name}</h6>
                                        <p class="mb-2 small text-muted">
                                            <i class="bi bi-car-front"></i> ${ride.car_color || ''} ${ride.car_model || ''}
                                        </p>
                                    </div>
                                    ${priceTag}
                                </div>

                                <div class="mb-2">
                                    <div class="small">
                                        <i class="bi bi-geo-alt text-success"></i> ${ride.from}
                                    </div>
                                    <div class="small">
                                        <i class="bi bi-flag text-danger"></i> ${ride.to}
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small text-muted">
                                        <i class="bi bi-clock"></i> ${ride.time}
                                    </div>
                                    <span class="badge bg-info">
                                        <i class="bi bi-people"></i> ${ride.seats} –º–µ—Å—Ç
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function showRideDetails(ride) {
        currentRide = ride;
        currentRideId = ride.id;

        const priceText = ride.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : ride.price + ' ‚ÇΩ';

        document.getElementById('bookModalBody').innerHTML = `
            <div class="text-center mb-4">
                <div class="driver-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                    ${ride.driver_name ? ride.driver_name[0] : '?'}
                </div>
                <h5>${ride.driver_name}</h5>
                <p class="text-muted small">
                    <i class="bi bi-star-fill text-warning"></i> ${ride.driver_rating || '5.0'}
                    <br><i class="bi bi-car-front"></i> ${ride.car_color || ''} ${ride.car_model || ''}
                    ${ride.car_number ? '<br>' + ride.car_number : ''}
                </p>
            </div>

            <div class="alert alert-info">
                <div class="d-flex mb-2">
                    <i class="bi bi-geo-alt text-success me-2"></i>
                    <span class="small">${ride.from}</span>
                </div>
                <div class="d-flex mb-2">
                    <i class="bi bi-flag text-danger me-2"></i>
                    <span class="small">${ride.to}</span>
                </div>
                <div class="d-flex mb-2">
                    <i class="bi bi-clock me-2"></i>
                    <span class="small">${ride.time}</span>
                </div>
                <div class="d-flex">
                    <i class="bi bi-people me-2"></i>
                    <span class="small">–°–≤–æ–±–æ–¥–Ω–æ: ${ride.seats} –º–µ—Å—Ç</span>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –Ω—É–∂–Ω–æ?</label>
                <input type="number" id="seatsInput" class="form-control" value="1" min="1" max="${ride.seats}">
            </div>

            <div class="mb-3">
                <label class="form-label">üìç –ì–¥–µ –≤–∞—Å –∑–∞–±—Ä–∞—Ç—å?</label>
                <input type="text" id="pickupPoint" class="form-control"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, –ø–æ–¥—ä–µ–∑–¥ 3"
                       value="${ride.from}">
            </div>

            <div class="mb-3">
                <label class="form-label">üèÅ –ì–¥–µ –≤—ã—Å–∞–¥–∏—Ç—å?</label>
                <input type="text" id="dropoffPoint" class="form-control"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É –º–∞–≥–∞–∑–∏–Ω–∞, 5 –ø–æ–¥—ä–µ–∑–¥"
                       value="${ride.to}">
            </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('bookModal'));
        modal.show();
    }

    function bookRide() {
        const seats = document.getElementById('seatsInput').value;
        const pickup = document.getElementById('pickupPoint').value;
        const dropoff = document.getElementById('dropoffPoint').value;

        fetch('/api/book_ride', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ride_id: currentRideId,
                seats: parseInt(seats),
                pickup_point: pickup,
                dropoff_point: dropoff
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è.');
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
            }
        });
    }
</script>
{% endblock %}