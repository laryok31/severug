{% extends "base.html" %}

{% block title %}–î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏ | –°–µ–≤–µ—Ä-–Æ–≥{% endblock %}

{% block extra_css %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=4932c58f-dc3f-4c34-b0ca-a64c1ef43dca&lang=ru_RU" type="text/javascript"></script>
<style>
    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø–æ–µ–∑–¥–∫–∏ */
    .ride-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 30px;
        padding: 30px;
        color: white;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .ride-hero::before {
        content: 'üöó';
        position: absolute;
        right: 20px;
        bottom: 20px;
        font-size: 8rem;
        opacity: 0.1;
        transform: rotate(15deg);
    }

    .route-badge {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        border-radius: 50px;
        padding: 8px 20px;
        display: inline-block;
        margin-bottom: 20px;
    }

    .driver-card {
        background: white;
        border-radius: 25px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }

    .driver-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
    }

    .info-item {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
    }

    .info-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #667eea;
    }

    .info-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .booking-card {
        background: white;
        border-radius: 25px;
        padding: 25px;
        margin-bottom: 25px;
        border: 2px solid #e9ecef;
    }

    .booking-item {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid;
        transition: all 0.3s;
    }

    .booking-item.pending {
        border-left-color: #ffc107;
    }

    .booking-item.approved {
        border-left-color: #28a745;
    }

    .booking-item.rejected {
        border-left-color: #dc3545;
        opacity: 0.7;
    }

    .booking-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-action {
        border-radius: 12px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-action:hover {
        transform: translateY(-2px);
    }

    .map-container {
        border-radius: 25px;
        overflow: hidden;
        height: 300px;
        margin-top: 20px;
        border: 3px solid white;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è —Å –º–∞—Ä—à—Ä—É—Ç–æ–º -->
<div class="ride-hero">
    <div class="route-badge">
        <i class="bi bi-geo-alt"></i> –ú–∞—Ä—à—Ä—É—Ç
    </div>
    <h2 class="mb-3">{{ ride.from_place }} ‚Üí {{ ride.to_place }}</h2>
    <div class="d-flex gap-4">
        <div><i class="bi bi-clock"></i> {{ ride.departure_time.strftime('%d.%m.%Y %H:%M') }}</div>
        <div><i class="bi bi-people"></i> {{ ride.seats }} –º–µ—Å—Ç</div>
        <div>
            {% if ride.price == 0 %}
            <span class="badge bg-warning">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
            {% else %}
            <span class="badge bg-info">{{ ride.price }} ‚ÇΩ</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ -->
        {% if ride.description %}
        <div class="driver-card">
            <h5 class="mb-3"><i class="bi bi-chat"></i> –û–ø–∏—Å–∞–Ω–∏–µ</h5>
            <p>{{ ride.description }}</p>
        </div>
        {% endif %}

        <!-- –î–ª—è –≤–æ–¥–∏—Ç–µ–ª—è - –∑–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        {% if user and user.id == ride.driver_id %}
        <div class="booking-card">
            <h5 class="mb-4"><i class="bi bi-list-check"></i> –ó–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
            {% if bookings %}
            {% for b in bookings %}
            {% if b.status != 'cancelled' %}
            <div class="booking-item {{ b.status }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex-grow: 1;">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="driver-avatar-small" style="width: 40px; height: 40px; border-radius: 10px; background: #667eea; color: white; display: flex; align-items: center; justify-content: center;">
                                {{ b.passenger.name[0] }}
                            </div>
                            <div>
                                <strong>{{ b.passenger.name }}</strong>
                                <span class="status-badge status-{{ b.status }}">
                                            {% if b.status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ
                                            {% elif b.status == 'approved' %}‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                                            {% elif b.status == 'rejected' %}‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                            {% endif %}
                                        </span>
                            </div>
                        </div>
                        <p class="mb-2 small">
                            <i class="bi bi-people"></i> {{ b.seats }} –º–µ—Å—Ç(–∞)
                            {% if b.pickup_point %}
                            <br><i class="bi bi-geo-alt"></i> –ó–∞–±—Ä–∞—Ç—å: {{ b.pickup_point }}
                            {% endif %}
                            {% if b.dropoff_point %}
                            <br><i class="bi bi-flag"></i> –í—ã—Å–∞–¥–∏—Ç—å: {{ b.dropoff_point }}
                            {% endif %}
                        </p>
                        <small class="text-muted">{{ b.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                    </div>
                    <div class="action-buttons">
                        <a href="/chat/{{ ride.id }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-chat"></i>
                        </a>
                        {% if b.status == 'pending' %}
                        <button class="btn btn-sm btn-success" onclick="approveBooking({{ b.id }})">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectBooking({{ b.id }})">
                            <i class="bi bi-x"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <p class="text-muted text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è -->
        <div class="driver-card">
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="driver-avatar-large">
                    {{ driver.name[0] }}
                </div>
                <div>
                    <h5 class="mb-1">{{ driver.name }}</h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary">‚≠ê {{ driver.driver_rating|default('5.0') }}</span>
                        <span class="badge bg-info">{{ driver.trips_count|default(0) }} –ø–æ–µ–∑–¥–æ–∫</span>
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-value">{{ driver.car_model or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</div>
                    <div class="info-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                </div>
                <div class="info-item">
                    <div class="info-value">{{ driver.car_color or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</div>
                    <div class="info-label">–¶–≤–µ—Ç</div>
                </div>
                <div class="info-item">
                    <div class="info-value">{{ driver.car_number or '–ù–µ—Ç' }}</div>
                    <div class="info-label">–ù–æ–º–µ—Ä</div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <a href="tel:{{ driver.contact_phone or driver.phone }}" class="btn btn-success btn-action">
                    <i class="bi bi-telephone"></i> –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                </a>
                {% if user and user.id != driver.id %}
                <button class="btn btn-outline-warning btn-action" onclick="toggleFavoriteDriver({{ driver.id }})">
                    <i class="bi bi-star"></i> –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                </button>
                {% endif %}
            </div>
        </div>

        <!-- –î–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞ - –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        {% if user and user.id != ride.driver_id %}
        <div class="booking-card">
            <h5 class="mb-4"><i class="bi bi-ticket"></i> –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>

            {% set passenger_booking = bookings|selectattr('passenger_id', 'equalto', user.id)|first %}

            {% if passenger_booking %}
            <div class="alert alert-{% if passenger_booking.status == 'approved' %}success{% elif passenger_booking.status == 'pending' %}warning{% else %}danger{% endif %}">
                <strong>
                    {% if passenger_booking.status == 'approved' %}‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    {% elif passenger_booking.status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    {% elif passenger_booking.status == 'rejected' %}‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                    {% endif %}
                </strong>
                <p class="mb-0 small">{{ passenger_booking.seats }} –º–µ—Å—Ç(–∞)</p>
            </div>

            <div class="action-buttons">
                <a href="/chat/{{ ride.id }}" class="btn btn-primary btn-action flex-grow-1">
                    <i class="bi bi-chat"></i> –ß–∞—Ç —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º
                </a>
                {% if passenger_booking.status != 'rejected' %}
                <button class="btn btn-danger btn-action" onclick="cancelBooking({{ ride.id }})">
                    <i class="bi bi-x-circle"></i>
                </button>
                {% endif %}
            </div>

            {% elif ride.seats > 0 %}
            <form id="bookingForm">
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
                    <select class="form-control-custom" id="seats">
                        {% for i in range(1, ride.seats + 1) %}
                        <option value="{{ i }}">{{ i }} {{ '–º–µ—Å—Ç–æ' if i == 1 else '–º–µ—Å—Ç–∞' if i < 5 else '–º–µ—Å—Ç' }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">üìç –ì–¥–µ –∑–∞–±—Ä–∞—Ç—å?</label>
                    <input type="text" class="form-control-custom" id="pickup"
                           value="{{ ride.from_place }}" placeholder="–ê–¥—Ä–µ—Å">
                </div>

                <div class="mb-3">
                    <label class="form-label">üèÅ –ì–¥–µ –≤—ã—Å–∞–¥–∏—Ç—å?</label>
                    <input type="text" class="form-control-custom" id="dropoff"
                           value="{{ ride.to_place }}" placeholder="–ê–¥—Ä–µ—Å">
                </div>

                <button type="button" class="btn btn-warning btn-action w-100" onclick="bookRide({{ ride.id }})">
                    <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                </button>
            </form>
            {% else %}
            <div class="alert alert-secondary">
                <i class="bi bi-info-circle"></i> –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
    let map;
    let currentRating = 0;

    ymaps.ready(init);

    function init() {
        map = new ymaps.Map("map", {
            center: [{{ (ride.from_lat + ride.to_lat)/2 }}, {{ (ride.from_lng + ride.to_lng)/2 }}],
            zoom: 12
        });

        ymaps.route([
            [{{ ride.from_lat }}, {{ ride.from_lng }}],
            [{{ ride.to_lat }}, {{ ride.to_lng }}]
        ]).then(function(route) {
            map.geoObjects.add(route);
        });

        const fromPlacemark = new ymaps.Placemark(
            [{{ ride.from_lat }}, {{ ride.from_lng }}],
            { balloonContent: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {{ ride.from_place }}' },
            { preset: 'islands#greenDotIcon' }
        );

        const toPlacemark = new ymaps.Placemark(
            [{{ ride.to_lat }}, {{ ride.to_lng }}],
            { balloonContent: '–ü—Ä–∏–±—ã—Ç–∏–µ: {{ ride.to_place }}' },
            { preset: 'islands#redDotIcon' }
        );

        map.geoObjects.add(fromPlacemark);
        map.geoObjects.add(toPlacemark);
    }

    function bookRide(rideId) {
        const seats = document.getElementById('seats').value;
        const pickup = document.getElementById('pickup').value;
        const dropoff = document.getElementById('dropoff').value;

        fetch('/api/book_ride', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ride_id: rideId,
                seats: parseInt(seats),
                pickup_point: pickup,
                dropoff_point: dropoff
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
            }
        });
    }

    function cancelBooking(rideId) {
        if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
            fetch('/api/cancel_booking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ride_id: rideId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    location.reload();
                }
            });
        }
    }

    function approveBooking(bookingId) {
        fetch(`/api/approve_booking/${bookingId}`, {method: 'POST'})
            .then(() => location.reload());
    }

    function rejectBooking(bookingId) {
        fetch(`/api/reject_booking/${bookingId}`, {method: 'POST'})
            .then(() => location.reload());
    }

    function toggleFavoriteDriver(driverId) {
        fetch('/api/favorite_driver', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ driver_id: driverId })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.favorite ? '‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '‚ùå –£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        });
    }
</script>
{% endblock %}